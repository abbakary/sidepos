{% extends 'tracker/base.html' %}
{% load static %}
{% block title %}Organizations{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="page-title"><div class="row"><div class="col-6"><h4>Organization Customers</h4></div><div class="col-6"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}">Home</a></li><li class="breadcrumb-item active">Organizations</li></ol></div></div></div>
</div>
<div class="container-fluid">
  <div class="row g-3 mb-3 align-items-end">
    <div class="col-lg-6">
      <form class="row g-2" method="get" action="">
        <div class="col-md-6"><input class="form-control" name="q" value="{{ q }}" placeholder="Search org, contact, phone, email, code"></div>
        <div class="col-md-3">
          <select class="form-select" name="status">
            <option value="">All</option>
            <option value="returning" {% if status == 'returning' %}selected{% endif %}>Returning (visits &gt; 1)</option>
          </select>
        </div>
        <div class="col-md-3"><select class="form-select" name="period"><option value="1month" {% if time_period == '1month' %}selected{% endif %}>30 days</option><option value="3months" {% if time_period == '3months' %}selected{% endif %}>3 months</option><option value="6months" {% if time_period == '6months' %}selected{% endif %}>6 months</option><option value="1year" {% if time_period == '1year' %}selected{% endif %}>1 year</option></select></div>
        <div class="col-12 d-flex gap-2"><button class="btn btn-primary" type="submit">Filter</button><a class="btn btn-outline-secondary" href="{% url 'tracker:organization_export' %}?q={{ q|urlencode }}&status={{ status }}&period={{ time_period }}">Export</a></div>
      </form>
    </div>
    <div class="col-lg-6 text-end">
      <div class="d-inline-flex gap-3"><span class="badge bg-primary">Gov: {{ counts.government|default:0 }}</span><span class="badge bg-info">NGO: {{ counts.ngo|default:0 }}</span><span class="badge bg-success">Company: {{ counts.company|default:0 }}</span><span class="badge bg-secondary">Total: {{ total_org }}</span></div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-xl-4">
      <div class="card h-100"><div class="card-header"><h6 class="mb-0">Order Types</h6></div><div class="card-body"><div id="orgTypeChart" style="height:260px"></div></div></div>
    </div>
    <div class="col-xl-8">
      <div class="card h-100"><div class="card-header d-flex justify-content-between align-items-center"><h6 class="mb-0">Monthly Orders</h6><span class="text-muted f-12">{{ start_date }} â†’ {{ end_date }}</span></div><div class="card-body"><div id="orgTrendChart" style="height:260px"></div></div></div>
    </div>
  </div>

  <div class="card mt-3">
    <div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0">Organizations</h5><div class="d-inline-flex gap-2"><span class="f-light f-12">Sort:</span><a class="btn btn-sm btn-light {% if sort_by=='last_order_date' %}active{% endif %}" href="?q={{ q|urlencode }}&status={{ status }}&period={{ time_period }}&sort=last_order_date">Last Order</a><a class="btn btn-sm btn-light {% if sort_by=='recent_orders_count' %}active{% endif %}" href="?q={{ q|urlencode }}&status={{ status }}&period={{ time_period }}&sort=recent_orders_count">Orders</a><a class="btn btn-sm btn-light {% if sort_by=='completed_orders' %}active{% endif %}" href="?q={{ q|urlencode }}&status={{ status }}&period={{ time_period }}&sort=completed_orders">Completed</a></div></div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table mb-0" id="orgTable">
          <thead>
            <tr>
              <th class="text-center">Truck</th>
              <th>Code</th>
              <th>Organization</th>
              <th>Contact</th>
              <th>Phone</th>
              <th>Type</th>
              <th>Visits</th>
              <th>Orders</th>
              <th>Service</th>
              <th>Sales</th>
              <th>Consult</th>
              <th>Completed</th>
              <th>Vehicles</th>
              <th>Last Order</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for c in customers %}
            <tr>
              <td class="text-center"><img class="truck-thumb" src="https://cdn.builder.io/api/v1/image/assets%2Fbebc376cdd2f4ab3aba9527a99ac7787%2F5125af9d931849989d61e52df11234aa?format=webp&width=800" alt="Truck"></td>
              <td>{{ c.code }}</td>
              <td>{{ c.organization_name|default:'-' }}</td>
              <td>{{ c.full_name }}</td>
              <td>{{ c.phone }}</td>
              <td class="text-capitalize">{{ c.customer_type }}</td>
              <td>{{ c.total_visits }}</td>
              <td>{{ c.recent_orders_count }}</td>
              <td>{{ c.service_orders }}</td>
              <td>{{ c.sales_orders }}</td>
              <td>{{ c.consultation_orders }}</td>
              <td>{{ c.completed_orders }}</td>
              <td>{{ c.vehicles_count }}</td>
              <td>{% if c.last_order_date %}{{ c.last_order_date|date:'Y-m-d' }}{% else %}-{% endif %}</td>
              <td class="text-end"><a class="btn btn-sm btn-outline-primary" href="{% url 'tracker:customer_detail' c.id %}">View</a></td>
            </tr>
            {% empty %}
            <tr><td colspan="15" class="text-center p-4">No records</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer"><nav><ul class="pagination mb-0">{% if customers.has_previous %}<li class="page-item"><a class="page-link" href="?page={{ customers.previous_page_number }}&q={{ q|urlencode }}&status={{ status }}&period={{ time_period }}">Prev</a></li>{% endif %}<li class="page-item disabled"><span class="page-link">Page {{ customers.number }} of {{ customers.paginator.num_pages }}</span></li>{% if customers.has_next %}<li class="page-item"><a class="page-link" href="?page={{ customers.next_page_number }}&q={{ q|urlencode }}&status={{ status }}&period={{ time_period }}">Next</a></li>{% endif %}</ul></nav></div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js' %}"></script>
<script>
  $(function(){ $('#orgTable').DataTable({ pageLength: 20, order:[[13,'desc']] }); });
  const charts = {{ charts_json|default:'{}'|safe }};
  function pieOption(labels, values){return {tooltip:{trigger:'item'},legend:{bottom:0},series:[{type:'pie',radius:['40%','70%'],label:{show:false},emphasis:{label:{show:true,fontSize:14}},data:labels.map((l,i)=>({name:l,value:values[i]||0}))}]}}
  function lineOption(labels, values){return {tooltip:{trigger:'axis'},xAxis:{type:'category',data:labels},yAxis:{type:'value'},grid:{left:40,right:10,top:20,bottom:40},series:[{type:'line',smooth:true,data:values,areaStyle:{}}]}}
  document.addEventListener('DOMContentLoaded', function(){ if(window.echarts){ echarts.init(document.getElementById('orgTypeChart')).setOption(pieOption(charts.type.labels, charts.type.values)); echarts.init(document.getElementById('orgTrendChart')).setOption(lineOption(charts.trend.labels, charts.trend.values)); }});
</script>
{% endblock %}
