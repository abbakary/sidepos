{% extends 'tracker/base.html' %}
{% load static %}
{% block title %}{% if mode == 'edit' %}Edit Item{% else %}Add Item{% endif %}{% endblock %}

{% block extra_css %}
<style>
  .form-label {
    font-weight: 500;
    margin-bottom: 0.25rem;
  }
  .form-text {
    font-size: 0.8rem;
    color: #6c757d;
  }
  .form-control, .form-select {
    border-radius: 0.25rem;
  }
  .form-check-input {
    margin-top: 0.3em;
  }
  .card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  .card-body {
    padding: 1.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6">
        <h4>{% if mode == 'edit' %}Edit Item{% else %}Add New Inventory Item{% endif %}</h4>
      </div>
      <div class="col-6">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'tracker:inventory_list' %}">Inventory</a></li>
          <li class="breadcrumb-item active">{% if mode == 'edit' %}Edit{% else %}Add{% endif %}</li>
        </ol>
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="card-body">
      <form method="post" novalidate>{% csrf_token %}
        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
              {{ error }}
            {% endfor %}
          </div>
        {% endif %}
        
        <div class="row g-3">
          <!-- Left Column -->
          <div class="col-md-6">
            <!-- Name -->
            <div class="mb-3">
              <label class="form-label" for="{{ form.name.id_for_label }}">
                {{ form.name.label }}{% if form.name.field.required %}<span class="text-danger">*</span>{% endif %}
              </label>
              {{ form.name }}
              {% if form.name.help_text %}
                <div class="form-text">{{ form.name.help_text }}</div>
              {% endif %}
              {% for error in form.name.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            
            <!-- Brand -->
            <div class="mb-3">
              <label class="form-label" for="{{ form.brand.id_for_label }}">
                {{ form.brand.label }}{% if form.brand.field.required %}<span class="text-danger">*</span>{% endif %}
              </label>
              {{ form.brand }}
              {% if form.brand.help_text %}
                <div class="form-text">{{ form.brand.help_text }}</div>
              {% endif %}
              {% for error in form.brand.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
              <div class="mt-1">
                <a href="#" class="small" data-bs-toggle="modal" data-bs-target="#addBrandModal">
                  <i class="fa fa-plus me-1"></i>Add New Brand
                </a>
              </div>
            </div>
            
            <!-- Description -->
            <div class="mb-3">
              <label class="form-label" for="{{ form.description.id_for_label }}">
                {{ form.description.label }}
              </label>
              {{ form.description }}
              {% if form.description.help_text %}
                <div class="form-text">{{ form.description.help_text }}</div>
              {% endif %}
              {% for error in form.description.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            
            <!-- SKU & Barcode -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label" for="{{ form.sku.id_for_label }}">
                    {{ form.sku.label }}
                  </label>
                  {{ form.sku }}
                  {% if form.sku.help_text %}
                    <div class="form-text">{{ form.sku.help_text }}</div>
                  {% endif %}
                  {% for error in form.sku.errors %}
                    <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label" for="{{ form.barcode.id_for_label }}">
                    {{ form.barcode.label }}
                  </label>
                  {{ form.barcode }}
                  {% if form.barcode.help_text %}
                    <div class="form-text">{{ form.barcode.help_text }}</div>
                  {% endif %}
                  {% for error in form.barcode.errors %}
                    <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Right Column -->
          <div class="col-md-6">
            <!-- Price & Cost -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label" for="{{ form.price.id_for_label }}">
                    {{ form.price.label }}{% if form.price.field.required %}<span class="text-danger">*</span>{% endif %}
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    {{ form.price }}
                  </div>
                  {% if form.price.help_text %}
                    <div class="form-text">{{ form.price.help_text }}</div>
                  {% endif %}
                  {% for error in form.price.errors %}
                    <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label" for="{{ form.cost_price.id_for_label }}">
                    {{ form.cost_price.label }}
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    {{ form.cost_price }}
                  </div>
                  {% if form.cost_price.help_text %}
                    <div class="form-text">{{ form.cost_price.help_text }}</div>
                  {% endif %}
                  {% for error in form.cost_price.errors %}
                    <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
              </div>
            </div>
            
            <!-- Quantity & Reorder Level -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label" for="{{ form.quantity.id_for_label }}">
                    {{ form.quantity.label }}
                  </label>
                  {{ form.quantity }}
                  {% if form.quantity.help_text %}
                    <div class="form-text">{{ form.quantity.help_text }}</div>
                  {% endif %}
                  {% for error in form.quantity.errors %}
                    <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label" for="{{ form.reorder_level.id_for_label }}">
                    {{ form.reorder_level.label }}
                  </label>
                  {{ form.reorder_level }}
                  {% if form.reorder_level.help_text %}
                    <div class="form-text">{{ form.reorder_level.help_text }}</div>
                  {% endif %}
                  {% for error in form.reorder_level.errors %}
                    <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
              </div>
            </div>
            
            <!-- Location -->
            <div class="mb-3">
              <label class="form-label" for="{{ form.location.id_for_label }}">
                {{ form.location.label }}
              </label>
              {{ form.location }}
              {% if form.location.help_text %}
                <div class="form-text">{{ form.location.help_text }}</div>
              {% endif %}
              {% for error in form.location.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            
            <!-- Active Status -->
            <div class="mb-3 form-check form-switch">
              {{ form.is_active }}
              <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                {{ form.is_active.label }}
              </label>
              {% if form.is_active.help_text %}
                <div class="form-text">{{ form.is_active.help_text }}</div>
              {% endif %}
              {% for error in form.is_active.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
          </div>
        </div>
        
        <div class="mt-4 pt-3 border-top d-flex justify-content-between">
          <div>
            <a href="{% url 'tracker:inventory_list' %}" class="btn btn-outline-secondary">
              <i class="fa fa-arrow-left me-1"></i> Back to List
            </a>
          </div>
          <div>
            <button type="submit" class="btn btn-primary">
              <i class="fa fa-save me-1"></i> {% if mode == 'edit' %}Update{% else %}Create{% endif %} Item
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Brand Modal -->
<div class="modal fade" id="addBrandModal" tabindex="-1" aria-labelledby="addBrandModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addBrandModalLabel">Add New Brand</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addBrandForm">
        <div class="modal-body">
          <div id="brandFormAlert" class="alert d-none" role="alert"></div>
          <div class="mb-3">
            <label for="brandName" class="form-label">Brand Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="brandName" name="name" required>
            <div class="form-text">Enter the name of the brand (e.g., Michelin, Goodyear, etc.)</div>
          </div>
          <div class="mb-3">
            <label for="brandDescription" class="form-label">Description</label>
            <textarea class="form-control" id="brandDescription" name="description" rows="2"></textarea>
            <div class="form-text">Optional description or notes about the brand</div>
          </div>
          <div class="mb-3">
            <label for="brandWebsite" class="form-label">Website</label>
            <input type="url" class="form-control" id="brandWebsite" name="website" placeholder="https://example.com">
            <div class="form-text">Optional website URL for the brand</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fa fa-times me-1"></i> Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="saveBrandBtn">
            <span class="spinner-border spinner-border-sm d-none" id="brandSpinner" role="status" aria-hidden="true"></span>
            <i class="fa fa-save me-1"></i> Save Brand
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Handle brand form submission via AJAX
  document.addEventListener('DOMContentLoaded', function() {
    const brandForm = document.getElementById('addBrandForm');
    if (!brandForm) return;
    
    brandForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const form = e.target;
      const submitBtn = document.getElementById('saveBrandBtn');
      const spinner = document.getElementById('brandSpinner');
      const alertDiv = document.getElementById('brandFormAlert');
      
      // Show loading state
      submitBtn.disabled = true;
      spinner.classList.remove('d-none');
      alertDiv.classList.add('d-none');
      
      // Prepare form data
      const formData = {
        name: document.getElementById('brandName').value.trim(),
        description: document.getElementById('brandDescription').value.trim(),
        website: document.getElementById('brandWebsite').value.trim()
      };
      
      // Validate form
      if (!formData.name) {
        showAlert('Brand name is required', 'danger');
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
        return;
      }
      
      // Send AJAX request
      fetch("{% url 'tracker:api_create_brand' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Add the new brand to the select dropdown
          const brandSelect = document.getElementById('{{ form.brand.id_for_label }}');
          const newOption = new Option(data.brand.name, data.brand.id, true, true);
          brandSelect.add(newOption);
          
          // Close the modal and reset the form
          const modal = bootstrap.Modal.getInstance(document.getElementById('addBrandModal'));
          modal.hide();
          form.reset();
          
          // Show success message
          showToast('Success', 'Brand added successfully!', 'success');
        } else {
          // Show error message in form
          showAlert(data.error || 'Failed to add brand', 'danger');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while adding the brand', 'danger');
      })
      .finally(() => {
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
      });
      
      function showAlert(message, type) {
        alertDiv.textContent = message;
        alertDiv.className = `alert alert-${type} mt-2`;
        alertDiv.classList.remove('d-none');
        alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    });
    
    // Reset form when modal is closed
    const brandModal = document.getElementById('addBrandModal');
    if (brandModal) {
      brandModal.addEventListener('hidden.bs.modal', function() {
        brandForm.reset();
        const alertDiv = document.getElementById('brandFormAlert');
        if (alertDiv) {
          alertDiv.classList.add('d-none');
          alertDiv.textContent = '';
        }
      });
    }
  });
  
  // Helper function to show toast messages
  function showToast(title, message, type = 'info') {
    const toastContainer = document.createElement('div');
    toastContainer.className = `toast align-items-center text-white bg-${type} border-0`;
    toastContainer.setAttribute('role', 'alert');
    toastContainer.setAttribute('aria-live', 'assertive');
    toastContainer.setAttribute('aria-atomic', 'true');
    
    toastContainer.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          <strong>${title}</strong><br>${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    document.body.appendChild(toastContainer);
    const toast = new bootstrap.Toast(toastContainer);
    toast.show();
    
    // Remove the toast after it's hidden
    toastContainer.addEventListener('hidden.bs.toast', function() {
      document.body.removeChild(toastContainer);
    });
  }
</script>
{% endblock %}
